Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),function(e,t){"function"==typeof define&&define.amd?define([],function(){return t(e)}):"object"==typeof exports?module.exports=t(e):e.Reef=t(e)}("undefined"!=typeof global?global:"undefined"!=typeof window?window:this,function(e){"use strict";var t,n=function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()},s=function(e){if(e)return JSON.parse(JSON.stringify(e))},i=function(e,t){var n=e.filter(t);return n.length<1?null:n[0]},r=function(e){return e},o=function(n,s){if(!function(){if(!e.DOMParser)return!1;t=t||new DOMParser;try{t.parseFromString("x","text/html")}catch(e){return!1}return!0}())throw new Error("Reef.js is not supported by this browser.");if(!(n||s&&s.lagoon))throw new Error("Reef.js: You did not provide an element to make into a component.");if(!s||!s.template&&!s.lagoon)throw new Error("Reef.js: You did not provide a template for this component.");if(this.elem=n,this.data=s.data,this.template=s.template,this.sanitize=s.sanitize,this.attached=[],this.lagoon=s.lagoon,s.attachTo){var i=this;s.attachTo.forEach(function(e){"attach"in e&&e.attach(i)})}};o.setSanitizer=function(e){r=e};var a=function(e,t){t.forEach(function(t){e.style[t]=""})},c=function(e,t){t.forEach(function(t){var n,s,r,o,c;"class"===t.att?e.className=t.value:"style"===t.att?(n=e,s=t.value,o=s.split(";").filter(function(e){return 0<e.indexOf(":")}).map(function(e){var t=e.split(":");return{name:t[0]?t[0].trim():"",value:t[1]?t[1].trim():""}}),c=Array.prototype.filter.call(n.style,function(e){return null===i(o,function(t){return t.name===e&&t.value===n.style[e]})}),a(n,c),r=n,o.forEach(function(e){r.style[e.name]=e.value})):e.setAttribute(t.att,t.value||!0)})},d=function(e){var t;return t="text"===e.type?document.createTextNode(e.content):"comment"===e.type?document.createComment(e.content):e.isSVG?document.createElementNS("http://www.w3.org/2000/svg",e.type):document.createElement(e.type),c(t,e.atts),0<e.children.length?e.children.forEach(function(e){t.appendChild(d(e))}):"text"!==e.type&&(t.textContent=e.content),t},l=function(e,t){var n,s=t.atts.filter(function(t){return null===i(e.atts,function(e){return t.att===e.att})}),r=e.atts.filter(function(e){var n=i(t.atts,function(t){return e.att===t.att});return null===n||n.value!==e.value});c(t.node,r),n=t.node,s.forEach(function(e){"class"===e.att?n.className="":"style"===e.att?a(n,Array.prototype.slice.call(n.style)):n.removeAttribute(e.att)})},u=function(e,t,n,s){var i=t.length-e.length;if(0<i)for(;0<i;i--)t[t.length-i].node.parentNode.removeChild(t[t.length-i].node);e.forEach(function(i,r){t[r]?e[r].type===t[r].type?(l(e[r],t[r]),0<s.filter(function(e){return 3!==i.node.nodeType&&i.node.matches(e)}).length||(e[r].content!==t[r].content&&(t[r].node.textContent=e[r].content),0<i.children.length&&u(i.children,t[r].children||[],t[r].node,s))):t[r].node.parentNode.replaceChild(d(e[r]),t[r].node):n.appendChild(d(e[r]))})},p=function(e,t){return Array.prototype.map.call(e.childNodes,function(e){var n,s={content:e.childNodes&&0<e.childNodes.length?null:e.textContent,atts:1!==e.nodeType?[]:(n=e.attributes,Array.prototype.map.call(n,function(e){return{att:e.name,value:e.value}})),type:3===e.nodeType?"text":8===e.nodeType?"comment":e.tagName.toLowerCase(),node:e};return s.isSVG=t||"svg"===s.type,s.children=p(e,s.isSVG),s})},h=function(e,t){e&&e.forEach(function(e){if(-1<e.attached.indexOf(t))throw new Error("ReefJS: "+t.elem+" has attached nodes that it is also attached to, creating an infinite loop.");"render"in e&&e.render()})};return o.prototype.render=function(){if(this.lagoon)h(this.attached,this);else{if(!this.template)throw new Error("Reef.js: No template was provided.");var n="string"==typeof this.elem?document.querySelector(this.elem):this.elem;if(!n)throw new Error("Reef.js: The DOM element to render your template into was not found.");var i="function"==typeof this.template?this.template(s(this.data)):this.template;if(-1!==["string","number"].indexOf(typeof i)){var o,a,c,d=p((a=i,o=(c=this.sanitize)&&"function"==typeof c?c(a):r(a),(t=t||new DOMParser).parseFromString(o,"text/html").body)),l=p(n),m=this.attached.map(function(e){return e.elem});if(u(d,l,n,m),"function"==typeof e.CustomEvent){var f=new CustomEvent("render",{bubbles:!0});n.dispatchEvent(f)}return h(this.attached,this),n}}},o.prototype.getData=function(){return s(this.data)},o.prototype.setData=function(e){if("object"!==n(e))throw new Error("ReefJS: The provided data is not an object.");for(var t in e)e.hasOwnProperty(t)&&(this.data[t]=e[t]);this.render()},o.prototype.attach=function(e){"array"===n(e)?Array.prototype.push.apply(this.attached,e):this.attached.push(e)},o.prototype.detach=function(e){var t="array"===n(e);this.attached=this.attached.filter(function(n){return t?-1===e.indexOf(n):n!==e})},o});const nimipayDiv=document.getElementById("nimipay");if(null===nimipayDiv){let e=document.createElement("div");e.setAttribute("id","nimipay"),document.body.appendChild(e)}!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).HubApi=t()}(this,function(){"use strict";class e{static byteLength(t){const[n,s]=e._getLengths(t);return e._byteLength(n,s)}static decode(t){e._initRevLookup();const[n,s]=e._getLengths(t),i=new Uint8Array(e._byteLength(n,s));let r=0;const o=s>0?n-4:n;let a=0;for(;a<o;a+=4){const n=e._revLookup[t.charCodeAt(a)]<<18|e._revLookup[t.charCodeAt(a+1)]<<12|e._revLookup[t.charCodeAt(a+2)]<<6|e._revLookup[t.charCodeAt(a+3)];i[r++]=n>>16&255,i[r++]=n>>8&255,i[r++]=255&n}if(2===s){const n=e._revLookup[t.charCodeAt(a)]<<2|e._revLookup[t.charCodeAt(a+1)]>>4;i[r++]=255&n}if(1===s){const n=e._revLookup[t.charCodeAt(a)]<<10|e._revLookup[t.charCodeAt(a+1)]<<4|e._revLookup[t.charCodeAt(a+2)]>>2;i[r++]=n>>8&255,i[r]=255&n}return i}static encode(t){const n=t.length,s=n%3,i=[];for(let r=0,o=n-s;r<o;r+=16383)i.push(e._encodeChunk(t,r,r+16383>o?o:r+16383));if(1===s){const s=t[n-1];i.push(e._lookup[s>>2]+e._lookup[s<<4&63]+"==")}else if(2===s){const s=(t[n-2]<<8)+t[n-1];i.push(e._lookup[s>>10]+e._lookup[s>>4&63]+e._lookup[s<<2&63]+"=")}return i.join("")}static encodeUrl(t){return e.encode(t).replace(/\//g,"_").replace(/\+/g,"-").replace(/=/g,".")}static decodeUrl(t){return e.decode(t.replace(/_/g,"/").replace(/-/g,"+").replace(/\./g,"="))}static _initRevLookup(){if(0===e._revLookup.length){e._revLookup=[];for(let t=0,n=e._lookup.length;t<n;t++)e._revLookup[e._lookup.charCodeAt(t)]=t;e._revLookup["-".charCodeAt(0)]=62,e._revLookup["_".charCodeAt(0)]=63}}static _getLengths(e){const t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");let n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}static _byteLength(e,t){return 3*(e+t)/4-t}static _tripletToBase64(t){return e._lookup[t>>18&63]+e._lookup[t>>12&63]+e._lookup[t>>6&63]+e._lookup[63&t]}static _encodeChunk(t,n,s){const i=[];for(let r=n;r<s;r+=3){const n=(t[r]<<16&16711680)+(t[r+1]<<8&65280)+(255&t[r+2]);i.push(e._tripletToBase64(n))}return i.join("")}}var t,n;e._lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e._revLookup=[],function(e){e[e.UINT8_ARRAY=0]="UINT8_ARRAY"}(t||(t={}));class s{static stringify(e){return JSON.stringify(e,s._jsonifyType)}static parse(e){return JSON.parse(e,s._parseType)}static _parseType(n,i){if(i&&i.hasOwnProperty&&i.hasOwnProperty(s.TYPE_SYMBOL)&&i.hasOwnProperty(s.VALUE_SYMBOL))switch(i[s.TYPE_SYMBOL]){case t.UINT8_ARRAY:return e.decode(i[s.VALUE_SYMBOL])}return i}static _jsonifyType(n,i){return i instanceof Uint8Array?s._typedObject(t.UINT8_ARRAY,e.encode(i)):i}static _typedObject(e,t){const n={};return n[s.TYPE_SYMBOL]=e,n[s.VALUE_SYMBOL]=t,n}}s.TYPE_SYMBOL="__",s.VALUE_SYMBOL="v";class i{static generateRandomId(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}}!function(e){e.OK="ok",e.ERROR="error"}(n||(n={}));const r="<postMessage>";class o{constructor(e=!0){this._store=e?window.sessionStorage:null,this._validIds=new Map,e&&this._restoreIds()}static _decodeIds(e){const t=s.parse(e),n=new Map;for(const e of Object.keys(t)){const s=parseInt(e,10);n.set(isNaN(s)?e:s,t[e])}return n}has(e){return this._validIds.has(e)}getCommand(e){const t=this._validIds.get(e);return t?t[0]:null}getState(e){const t=this._validIds.get(e);return t?t[1]:null}add(e,t,n=null){this._validIds.set(e,[t,n]),this._storeIds()}remove(e){this._validIds.delete(e),this._storeIds()}clear(){this._validIds.clear(),this._store&&this._store.removeItem(o.KEY)}_encodeIds(){const e=Object.create(null);for(const[t,n]of this._validIds)e[t]=n;return s.stringify(e)}_restoreIds(){const e=this._store.getItem(o.KEY);e&&(this._validIds=o._decodeIds(e))}_storeIds(){this._store&&this._store.setItem(o.KEY,this._encodeIds())}}o.KEY="rpcRequests";class a{static receiveRedirectCommand(e){const t=new URL(e.href);if(!document.referrer)return null;const n=new URL(document.referrer),i=new URLSearchParams(t.search),o=new URLSearchParams(t.hash.substring(1));if(!o.has("id"))return null;const c=parseInt(o.get("id"),10);if(o.delete("id"),i.set(a.URL_SEARCHPARAM_NAME,c.toString()),!o.has("command"))return null;const d=o.get("command");if(o.delete("command"),!o.has("returnURL"))return null;const l=o.get("returnURL");o.delete("returnURL");const u=l===r&&(window.opener||window.parent);if(!u&&new URL(l).origin!==n.origin)return null;let p=[];if(o.has("args"))try{p=s.parse(o.get("args"))}catch(e){}return p=Array.isArray(p)?p:[],o.delete("args"),t.search=i.toString(),this._setUrlFragment(t,o),history.replaceState(history.state,"",t.href),{origin:n.origin,data:{id:c,command:d,args:p},returnURL:l,source:u?window.opener||window.parent:null}}static receiveRedirectResponse(e){const t=new URL(e.href);if(!document.referrer)return null;const i=new URL(document.referrer),r=new URLSearchParams(t.search),o=new URLSearchParams(t.hash.substring(1));if(!o.has("id"))return null;const c=parseInt(o.get("id"),10);if(o.delete("id"),r.set(a.URL_SEARCHPARAM_NAME,c.toString()),!o.has("status"))return null;const d=o.get("status")===n.OK?n.OK:n.ERROR;if(o.delete("status"),!o.has("result"))return null;const l=s.parse(o.get("result"));return o.delete("result"),t.search=r.toString(),this._setUrlFragment(t,o),history.replaceState(history.state,"",t.href),{origin:i.origin,data:{id:c,status:d,result:l}}}static prepareRedirectReply(e,t,n){const i=new URL(e.returnURL),r=new URLSearchParams(i.hash.substring(1));return r.set("id",e.id.toString()),r.set("status",t),r.set("result",s.stringify(n)),i.hash=r.toString(),i.href}static prepareRedirectInvocation(e,t,n,i,r){const o=new URL(e),a=new URLSearchParams(o.hash.substring(1));return a.set("id",t.toString()),a.set("returnURL",n),a.set("command",i),Array.isArray(r)&&a.set("args",s.stringify(r)),o.hash=a.toString(),o.href}static _setUrlFragment(e,t){t.toString().endsWith("=")?e.hash=t.toString().slice(0,-1):e.hash=t.toString()}}a.URL_SEARCHPARAM_NAME="rpcId";class c{constructor(e,t=!1){this._allowedOrigin=e,this._waitingRequests=new o(t),this._responseHandlers=new Map,this._preserveRequests=!1}onResponse(e,t,n){this._responseHandlers.set(e,{resolve:t,reject:n})}_receive(e){if(!e.data||!e.data.status||!e.data.id||"*"!==this._allowedOrigin&&e.origin!==this._allowedOrigin)return!1;const t=e.data,s=this._getCallback(t.id),i=this._waitingRequests.getState(t.id);if(s){if(this._preserveRequests||(this._waitingRequests.remove(t.id),this._responseHandlers.delete(t.id)),console.debug("RpcClient RECEIVE",t),t.status===n.OK)s.resolve(t.result,t.id,i);else if(t.status===n.ERROR){const e=new Error(t.result.message);t.result.stack&&(e.stack=t.result.stack),t.result.name&&(e.name=t.result.name),s.reject(e,t.id,i)}return!0}return console.warn("Unknown RPC response:",t),!1}_getCallback(e){if(this._responseHandlers.has(e))return this._responseHandlers.get(e);{const t=this._waitingRequests.getCommand(e);if(t)return this._responseHandlers.get(t)}}}class d extends c{constructor(e,t){super(t),this._serverCloseCheckInterval=-1,this._target=e,this._connectionState=0,this._receiveListener=this._receive.bind(this)}async init(){2!==this._connectionState&&(await this._connect(),window.addEventListener("message",this._receiveListener),-1===this._serverCloseCheckInterval&&(this._serverCloseCheckInterval=window.setInterval(()=>this._checkIfServerClosed(),300)))}async call(e,...t){return this._call({command:e,args:t,id:i.generateRandomId()})}close(){this._connectionState=0,window.removeEventListener("message",this._receiveListener),window.clearInterval(this._serverCloseCheckInterval),this._serverCloseCheckInterval=-1;for(const[e,{reject:t}]of this._responseHandlers){const n=this._waitingRequests.getState(e);t("Connection was closed","number"==typeof e?e:void 0,n)}this._waitingRequests.clear(),this._responseHandlers.clear(),this._target&&this._target.closed&&(this._target=null)}_receive(e){return e.source===this._target&&super._receive(e)}async _call(e){if(!this._target||this._target.closed)throw new Error("Connection was closed.");if(2!==this._connectionState)throw new Error("Client is not connected, call init first");return new Promise((t,n)=>{this._responseHandlers.set(e.id,{resolve:t,reject:n}),this._waitingRequests.add(e.id,e.command),console.debug("RpcClient REQUEST",e.command,e.args),this._target.postMessage(e,this._allowedOrigin)})}_connect(){if(2!==this._connectionState)return this._connectionState=1,new Promise((e,t)=>{const s=t=>{const{source:i,origin:r,data:o}=t;if(i===this._target&&o.status===n.OK&&"pong"===o.result&&1===o.id&&("*"===this._allowedOrigin||r===this._allowedOrigin)){if(o.result.stack){const e=new Error(o.result.message);e.stack=o.result.stack,o.result.name&&(e.name=o.result.name),console.error(e)}window.removeEventListener("message",s),this._connectionState=2,console.log("RpcClient: Connection established"),e(!0)}};window.addEventListener("message",s);const i=()=>{if(2!==this._connectionState){if(0===this._connectionState||this._checkIfServerClosed())return window.removeEventListener("message",s),void t(new Error("Connection was closed"));try{this._target.postMessage({command:"ping",id:1},this._allowedOrigin)}catch(e){console.error(`postMessage failed: ${e}`)}window.setTimeout(i,100)}};window.setTimeout(i,100)})}_checkIfServerClosed(){return!(this._target&&!this._target.closed||(this.close(),0))}}class l extends c{constructor(e,t,n=!0){super(t,!0),this._target=e,this._preserveRequests=n}async init(){const e=a.receiveRedirectResponse(window.location);if(e)return void this._receive(e);if(this._rejectOnBack())return;const t=new URLSearchParams(window.location.search);if(t.has(a.URL_SEARCHPARAM_NAME)){const e=window.sessionStorage.getItem(`response-${t.get(a.URL_SEARCHPARAM_NAME)}`);if(e)return void this._receive(s.parse(e),!1)}}close(){}call(e,t,n=!1,...s){this.callAndSaveLocalState(e,null,t,n,...s)}callAndSaveLocalState(e,t,n,s=!1,...r){const o=i.generateRandomId(),c=a.prepareRedirectInvocation(this._target,o,e,n,r);this._waitingRequests.add(o,n,t),s&&history.replaceState(Object.assign({},history.state,{rpcBackRejectionId:o}),""),console.debug("RpcClient REQUEST",n,r),window.location.href=c}_receive(e,t=!0){const n=super._receive(e);return n&&t&&window.sessionStorage.setItem(`response-${e.data.id}`,s.stringify(e)),n}_rejectOnBack(){if(!history.state||!history.state.rpcBackRejectionId)return!1;const e=history.state.rpcBackRejectionId;history.replaceState(Object.assign({},history.state,{rpcBackRejectionId:null}),"");const t=this._getCallback(e),n=this._waitingRequests.getState(e);if(t){this._preserveRequests||(this._waitingRequests.remove(e),this._responseHandlers.delete(e)),console.debug("RpcClient BACK");const s=new Error("Request aborted");return t.reject(s,e,n),!0}return!1}}class u{constructor(e){this._type=e}static getAllowedOrigin(e){return new URL(e).origin}async request(e,t,n){throw new Error("Not implemented")}}var p,h;!function(e){e[e.REDIRECT=0]="REDIRECT",e[e.POPUP=1]="POPUP",e[e.IFRAME=2]="IFRAME"}(p||(p={}));class m extends u{static withLocalState(e){return new m(void 0,e)}constructor(e,t){super(p.REDIRECT);const n=window.location;if(this._returnUrl=e||`${n.origin}${n.pathname}`,this._localState=t||{},void 0!==this._localState.__command)throw new Error("Invalid localState: Property '__command' is reserved")}async request(e,t,n){const s=u.getAllowedOrigin(e),i=new l(e,s);await i.init();const r=Object.assign({},this._localState,{__command:t});i.callAndSaveLocalState(this._returnUrl,r,t,!0,...n)}}class f extends u{constructor(e=f.DEFAULT_OPTIONS){super(p.POPUP),this._options=e}async request(e,t,n){const s=u.getAllowedOrigin(e),i=this.createPopup(e),r=new d(i,s);await r.init();try{return await r.call(t,...n)}catch(e){throw e}finally{r.close(),i.close()}}createPopup(e){const t=window.open(e,"NimiqAccounts",this._options);if(!t)throw new Error("Failed to open popup");return t}}f.DEFAULT_OPTIONS="";class g extends u{constructor(){super(p.IFRAME),this._iframe=null,this._client=null}async request(e,t,n){if(this._iframe&&this._iframe.src!==`${e}${g.IFRAME_PATH_SUFFIX}`)throw new Error("Hub iframe is already opened with another endpoint");const s=u.getAllowedOrigin(e);if(this._iframe||(this._iframe=await this.createIFrame(e)),!this._iframe.contentWindow)throw new Error(`IFrame contentWindow is ${typeof this._iframe.contentWindow}`);return this._client||(this._client=new d(this._iframe.contentWindow,s),await this._client.init()),await this._client.call(t,...n)}async createIFrame(e){return new Promise((t,n)=>{const s=document.createElement("iframe");s.name="NimiqAccountsIFrame",s.style.display="none",document.body.appendChild(s),s.src=`${e}${g.IFRAME_PATH_SUFFIX}`,s.onload=(()=>t(s)),s.onerror=n})}}g.IFRAME_PATH_SUFFIX="/iframe.html",function(e){e.LIST="list",e.MIGRATE="migrate",e.CHECKOUT="checkout",e.SIGN_MESSAGE="sign-message",e.SIGN_TRANSACTION="sign-transaction",e.ONBOARD="onboard",e.SIGNUP="signup",e.LOGIN="login",e.EXPORT="export",e.CHANGE_PASSWORD="change-password",e.LOGOUT="logout",e.ADD_ADDRESS="add-address",e.RENAME="rename",e.CHOOSE_ADDRESS="choose-address"}(h||(h={}));class _{constructor(e=_.DEFAULT_ENDPOINT,t){this._endpoint=e,this._defaultBehavior=t||new f(`left=${window.innerWidth/2-400},top=75,width=800,height=850,location=yes,dependent=yes`),this._iframeBehavior=new g,this._redirectClient=new l("",u.getAllowedOrigin(this._endpoint))}static get DEFAULT_ENDPOINT(){const e=location.origin.split(".");switch(e.shift(),e.join(".")){case"nimiq.com":return"https://hub.nimiq.com";case"nimiq-testnet.com":return"https://hub.nimiq-testnet.com";default:return"http://localhost:8080"}}checkRedirectResponse(){return this._redirectClient.init()}on(e,t,n){this._redirectClient.onResponse(e,(e,n,s)=>t(e,s),(e,t,s)=>{n&&n(e,s)})}checkout(e,t=this._defaultBehavior){return this._request(t,h.CHECKOUT,[e])}chooseAddress(e,t=this._defaultBehavior){return this._request(t,h.CHOOSE_ADDRESS,[e])}signTransaction(e,t=this._defaultBehavior){return this._request(t,h.SIGN_TRANSACTION,[e])}signMessage(e,t=this._defaultBehavior){return this._request(t,h.SIGN_MESSAGE,[e])}onboard(e,t=this._defaultBehavior){return this._request(t,h.ONBOARD,[e])}signup(e,t=this._defaultBehavior){return this._request(t,h.SIGNUP,[e])}login(e,t=this._defaultBehavior){return this._request(t,h.LOGIN,[e])}logout(e,t=this._defaultBehavior){return this._request(t,h.LOGOUT,[e])}export(e,t=this._defaultBehavior){return this._request(t,h.EXPORT,[e])}changePassword(e,t=this._defaultBehavior){return this._request(t,h.CHANGE_PASSWORD,[e])}addAddress(e,t=this._defaultBehavior){return this._request(t,h.ADD_ADDRESS,[e])}rename(e,t=this._defaultBehavior){return this._request(t,h.RENAME,[e])}migrate(e=this._defaultBehavior){return this._request(e,h.MIGRATE,[{appName:"Account list"}])}list(e=this._iframeBehavior){return this._request(e,h.LIST,[])}_request(e,t,n){return e.request(this._endpoint,t,n)}}return _.RequestType=h,_.RedirectRequestBehavior=m,_.MSG_PREFIX="Nimiq Signed Message:\n",_});const hubApi=new HubApi("https://hub.nimiq.com");let np=new Reef("#nimipay",{data:{txData:null,result:{address:"",label:""},invoices:[],items:[],userBalanceNim:null,userBalanceUsd:null,invoicesString:"",itemsString:"",checkoutFeedback:"",invoicesCount:0,itemsCount:0},template:function(e){return'<div class="np-modal-window" id="np-modal"><div class="np-modal-content"><div id="np-wallet" class="np-wallet"><div onclick="npCloseModal()" class="np-modal-close">✕</div><b>My NIM Wallet</b><br><br><div id="identicon"><img src="https://icons.mopsus.com/icon/'+e.result.address.replace(/\s/g,"")+'.png"></svg></div><span id="output"><span style="font-size:14px;">'+e.result.address+"<br>"+e.result.label+'</span></span><div id="balance"><br>Balance: '+e.userBalanceNim+" NIM ("+e.userBalanceUsd+' USD)</div><div id="balance-usd"></div><div style="height:5px;"></div><div class="np-wallet-func"><a href="https://old.changelly.com/exchange/BTC/NIM/0.1?ref_id=1gapuvxsnq7myyhb" class="np-link" target="_blank">Top Up</a> | <a href="https://safe.nimiq.com/" target="_blank">Backup</a></div></div><div class="np-tabs"><div class="np-btn" onclick="npShowInvoices()">Invoices ('+e.invoicesCount+')</div><div class="np-btn" onclick="npShowItems()">Items ('+e.itemsCount+')</div></div><div id="np-tab-invoices">'+e.invoicesString+'</div><div id="np-tab-items">'+e.itemsString+"</div></div></div>"}});function npInvoiceStringMaker(e,t,n,s,i){let r='<div class="np-wallet"><div class="charge"><b>Invoice #'+e+"</b><br><br>Payment sum: "+t+" USD ("+n+' NIM)<br><br><div id="np-invoice-'+e+'">';return""==s?r+='<div class="np-btn np-btn-small" onclick="npCheckoutPrepare(\''+e+"')\">Pay "+n+" NIM</div>":"pending"==s?(r+='<b>Pending confirmation...</b> <span class="np-loading np-line"></span><br><br>',setTimeout(function(){npTxBackendValidate(i,e)},5e3)):(stats="confirmed")&&(r+='Payment received: <a href="https://nimiq.watch/#'+i+'" target="_blank">Explore</a><br><br>'),r+='</div><div id="np-error-'+e+'"></div></div>'}function npItemsStringMaker(e,t,n){if("fortune_cookie"==t)return'<div class="np-wallet">Fortune Cookie #'+e+'<br><div class="np-nimiqookie-content"><div style="line-height:22px;padding:20px;"><b>'+n+"</b></div></div></div>"}function npCloseModal(){document.getElementById("np-modal").style.display="none"}function npShowInvoices(){document.getElementById("np-tab-invoices").style.display="block",document.getElementById("np-tab-items").style.display="none"}function npShowItems(){document.getElementById("np-tab-invoices").style.display="none",document.getElementById("np-tab-items").style.display="block"}function npWallet(){try{hubApi.chooseAddress({appName:"Nimipay"}).then(e=>{void 0!==np.data.result.address&&np.data.result.address!=e.address&&np.setData({txData:null,result:{address:"",label:""},invoices:[],items:[],userBalanceNim:null,userBalanceUsd:null,invoicesString:"",itemsString:"",checkoutFeedback:"",invoicesCount:0,itemsCount:0}),np.render(),np.setData({result:e}),document.getElementById("np-modal").style.display="block",npGetBalance(),npSendUserAddress()})}catch(e){console.log(e.message)}}function npGetInvoiceIndex(e){for(let t=0;t<np.data.invoices.length;t+=1)if(np.data.invoices[t].id_invoice==e)return t}function npCheckout(e,t){console.log(e);let n=npGetInvoiceIndex(e),s=(np.data.invoices[n].value/t).toFixed(2),i=Number((1e5*s).toFixed(2));if(Number(s)>Number(np.data.userBalanceNim))return void(document.getElementById("np-error-"+e).innerHTML='<div style="margin-top:5px;margin-bottom:10px;color:red;">You do not have enough NIM to pay the invoice.</div>');const r={appName:nimAddressLabel,recipient:nimAddress,value:i,extraData:"Invoice #"+e,sender:np.data.result.address,forceSender:!0};hubApi.checkout(r).then(t=>{document.getElementById("np-invoice-"+e).innerHTML='<b>Confirming transaction...</b> <span class="np-loading np-line"></span><div style="height:10px;"></div><div style="font-size:13px;padding-left:6px;padding-right:6px;margin-bottom:10px;">After the transaction is confirmed, your order will be activated. Please wait, or open your wallet later to see the new item.</div></div>',npSendTxHash(e,t.hash),npTxBackendValidate(t.hash,e)}).catch(e=>{console.log("Error: ",e)})}function npCheckoutPrepare(e){let t=new XMLHttpRequest;t.onload=function(){t.status>=200&&t.status<300?npCheckout(e,JSON.parse(t.response).nim_qc):console.log("The request failed!")},t.open("GET","https://nimiq.mopsus.com/api/price?currency=usd"),t.send()}function npAddItem(){let e=new XMLHttpRequest;if(""!=np.data.result.address)e.onload=function(){e.status>=200&&e.status<300?e.response&&(document.getElementById("np-modal").style.display="block",npSendUserAddress()):console.log("The request failed!")},e.open("GET","nimipay.php?action=npAddItem&data="+np.data.result.address),e.send();else try{hubApi.chooseAddress({appName:"Nimipay"}).then(t=>{e.onload=function(){e.status>=200&&e.status<300?e.response&&(np.render(),np.setData({result:t}),document.getElementById("np-modal").style.display="block",npGetBalance(),npSendUserAddress()):console.log("The request failed!")},e.open("GET","nimipay.php?action=npAddItem&data="+t.address),e.send()})}catch(e){console.log(e.message)}}function npAddItemCheckout(){alert("Soon...")}function npDonate(){alert("Soon...")}function npGetBalance(){let e=new XMLHttpRequest;e.onload=function(){if(e.status>=200&&e.status<300){npGetBalanceUsd(JSON.parse(e.response).balance/1e5)}},e.open("GET","https://nimiq.mopsus.com/api/balance/"+np.data.result.address),e.send()}function npGetBalanceUsd(e){let t=new XMLHttpRequest;t.onload=function(){if(t.status>=200&&t.status<300){let n=(JSON.parse(t.response).nim_qc*e).toFixed(2);np.setData({userBalanceUsd:n,userBalanceNim:e.toFixed(2)})}},t.open("GET","https://nimiq.mopsus.com/api/price?currency=usd"),t.send()}function npTxBackendValidate(e,t){let n=new XMLHttpRequest;n.onload=function(){n.status>=200&&n.status<300?"pending"==n.response?(console.log("Validating Tx: trying again..."),document.getElementById("np-invoice-"+t).innerHTML='<b>Confirming transaction...</b> <span class="np-loading np-line"></span><div style="height:10px;"></div><div style="font-size:13px;padding-left:6px;padding-right:6px;margin-bottom:10px;">After the transaction is confirmed, your order will be activated. Please wait, or open your wallet later to see the new item.</div></div>',"none"!=document.getElementById("np-modal").style.display&&setTimeout(function(){npTxBackendValidate(e,t)},1e4)):npSendUserAddress():console.log("The request failed!")},n.open("GET","nimipay.php?action=validateTx&data="+JSON.stringify({tx:e,id_invoice:t})),n.send()}function npInvoicesPriceInNim(){let e=new XMLHttpRequest;e.onload=function(){if(e.status>=200&&e.status<300){let t="";np.data.invoices.forEach(n=>{let s=n.value/JSON.parse(e.response).nim_qc;t+=npInvoiceStringMaker(n.id_invoice,Number(n.value).toFixed(2),s.toFixed(2),n.status,n.tx),t+="</div>"}),np.setData({invoicesString:t})}else console.log("The request failed!")},e.open("GET","https://nimiq.mopsus.com/api/price?currency=usd"),e.send()}function npCreateItems(){np.setData({itemsCount:np.data.items.length});let e="";np.data.items.forEach(t=>{e+=npItemsStringMaker(t.id_invoice,t.type,t.content)}),np.setData({itemsString:e})}function npSendUserAddress(){let e=new XMLHttpRequest;e.onload=function(){if(e.status>=200&&e.status<300){let t=JSON.parse(e.response);"initial"==t[1]?npSendUserAddress():(np.setData({invoicesCount:t[0].length}),np.setData({invoices:t[0]}),np.setData({items:t[1]}),npInvoicesPriceInNim(),npCreateItems())}else console.log("The request failed!")},e.open("GET","nimipay.php?action=sendUserAddress&data="+JSON.stringify(np.data.result)),e.send()}function npSendTxHash(e,t){let n=new XMLHttpRequest;n.onload=function(){n.status>=200&&n.status<300||console.log("The request failed!")},n.open("GET","nimipay.php?action=sendTxHash&data="+JSON.stringify({address:np.data.result.address,invoice:e,tx:t})),n.send()}